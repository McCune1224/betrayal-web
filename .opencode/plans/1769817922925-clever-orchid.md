# Backend Logging Implementation Plan

## Overview
Implement comprehensive, structured logging for the Go backend using Go 1.21's `slog` package. This will provide excellent observability during development and in production.

## Goals
1. Structured JSON logs in production, readable text in development
2. HTTP request/response logging with timing and status
3. WebSocket lifecycle tracking (connect, disconnect, errors)
4. Game event logging (room operations, player actions, phase changes)
5. Database operation logging with query timing
6. Request correlation IDs for distributed tracing
7. Log levels (DEBUG, INFO, WARN, ERROR) for filtering
8. Performance metrics (request duration, active connections)

## Implementation Tasks

### 1. Create Logging Package (`internal/logging/`)

**New File: `internal/logging/logger.go`**
- Configure slog with environment-based handlers
- JSON handler for production (LOG_FORMAT=json)
- Text handler for development (LOG_FORMAT=text or unset)
- Log level configuration via LOG_LEVEL env var
- Request ID generation and context propagation
- Helper functions for common log patterns

**Key Features:**
```go
- InitLogger() - Initialize global logger with config
- WithRequestID(ctx) - Add request ID to context
- RequestLogger(ctx) - Get logger with request ID
- HTTPMiddleware() - Echo middleware for request logging
- WSLogger(room, player) - Create logger for WebSocket client
```

### 2. Update Main Application (`cmd/server/main.go`)

**Changes:**
- Initialize logging package at startup
- Add structured startup logging (version, config, port)
- Replace `log.Fatalf` with structured error logging
- Add graceful shutdown logging
- Log server configuration (port, database status)

**Logging Points:**
- Application startup with version info
- Database connection success/failure
- Server start with port
- Fatal errors with full context

### 3. HTTP Request Logging Middleware

**New File: `internal/logging/middleware.go`**

**Features:**
- Request ID injection (X-Request-ID header or generated UUID)
- Request logging: method, path, remote_addr, request_id
- Response logging: status, duration, response_size
- Skip logging for health checks (optional)
- Error logging with stack traces in development

**Log Format Example:**
```json
{
  "time": "2026-01-30T10:00:00Z",
  "level": "INFO",
  "msg": "HTTP request",
  "request_id": "uuid-here",
  "method": "POST",
  "path": "/api/rooms",
  "status": 201,
  "duration_ms": 45,
  "remote_addr": "127.0.0.1:54321"
}
```

### 4. WebSocket Logging Enhancement

**Update: `internal/handlers/ws.go`**
- Add structured logging for WebSocket upgrade attempts
- Log upgrade failures with detailed error context
- Log successful connections with room, player, and connection info

**Update: `internal/game/client.go`**
- Add logger field to Client struct
- Log connection lifecycle events:
  - Client connected (room, player, is_host)
  - Client disconnected (room, player, duration)
  - Message received (type, size)
  - Message handling errors
  - Ping/pong failures
- Add debug logging for message content (truncated for large messages)

**Update: `internal/game/hub.go`**
- Log client registration/unregistration
- Log room creation/deletion
- Log broadcast operations (room, message_type, recipient_count)
- Log slow client disconnections
- Add metrics: active_rooms, total_clients

### 5. Room Management Logging

**Update: `internal/game/room.go`**
- Log room lifecycle:
  - Room created (code, host_id)
  - Room deleted (code, reason)
- Log player operations:
  - Player joined (room, player_id, player_name)
  - Player left (room, player_id, duration)
- Log game state changes:
  - Phase transitions (room, from_phase, to_phase, triggered_by)
  - Action submissions (room, player, action_type)
- Log validation errors with context

### 6. Database Logging

**Update: `internal/db/db.go`**
- Log connection pool initialization with config
- Log connection failures with retry attempts
- Add query logging wrapper (optional, debug level)
- Log slow queries (> 100ms threshold)
- Log connection pool metrics periodically (debug level)

### 7. Handler Logging

**Update: `internal/handlers/rooms.go`**
- Log room creation requests with host name
- Log room join attempts with room code
- Log validation errors with request details
- Log successful operations with response summary

**Update: `internal/handlers/health.go`**
- Log health check results (database status, response time)

### 8. Environment Configuration

**Update: `backend/.env.example`**
```bash
# Logging configuration
LOG_LEVEL=info          # debug, info, warn, error
LOG_FORMAT=text         # text (dev) or json (prod)
LOG_REQUEST_BODY=false  # Log HTTP request bodies (careful with sensitive data)
LOG_SQL_QUERIES=false   # Log SQL queries (debug only)
```

**Update: `backend/Dockerfile`**
- Set LOG_FORMAT=json for production builds

### 9. Testing Considerations

- Use test logger that writes to `testing.T` for test output
- Add `NewTestLogger(t)` helper for test utilities
- Ensure logs don't pollute test output unnecessarily
- Add log assertions in integration tests where appropriate

### 10. Documentation

**Update: `AGENTS.md`**
- Add logging best practices section
- Document log levels and when to use each
- Document request ID propagation
- Example log queries for common issues

## Log Level Guidelines

- **DEBUG**: Detailed information for debugging (message contents, query details)
- **INFO**: Normal operations (requests, connections, phase changes)
- **WARN**: Unexpected but handled situations (slow clients, validation failures)
- **ERROR**: Errors that need attention (connection failures, panics)

## Critical Log Events

These events must always be logged at INFO or higher:

1. Application startup/shutdown
2. Database connection success/failure
3. WebSocket connect/disconnect
4. Room created/deleted
5. Player joined/left
6. Game phase changes
7. Action submissions
8. HTTP errors (4xx, 5xx)
9. WebSocket errors and disconnections

## Files to Modify

1. **New Files:**
   - `internal/logging/logger.go` - Core logging setup
   - `internal/logging/middleware.go` - HTTP middleware
   - `internal/logging/ws.go` - WebSocket logging helpers

2. **Modified Files:**
   - `cmd/server/main.go` - Initialize logging, structured startup logs
   - `internal/handlers/rooms.go` - Request/response logging
   - `internal/handlers/ws.go` - WebSocket connection logging
   - `internal/handlers/health.go` - Health check logging
   - `internal/game/hub.go` - Hub operation logging
   - `internal/game/client.go` - Client lifecycle logging
   - `internal/game/room.go` - Room state logging
   - `internal/db/db.go` - Database operation logging
   - `backend/.env.example` - Add logging config
   - `AGENTS.md` - Document logging practices

## Verification Steps

1. Start server and verify startup logs show configuration
2. Make HTTP requests and verify request/response logging
3. Connect WebSocket client and verify connection logs
4. Create room and verify room creation logging
5. Join room and verify player join logging
6. Disconnect and verify cleanup logs
7. Check JSON format in production mode
8. Verify log levels filter correctly
9. Run tests and verify no log pollution
10. Check that request IDs propagate correctly

## Example Log Output

**Development (text format):**
```
2026-01-30 10:00:00 INFO  Server starting port=8080
2026-01-30 10:00:01 INFO  Database connected pool_size=10
2026-01-30 10:00:05 INFO  HTTP request method=POST path=/api/rooms status=201 duration=45ms request_id=abc-123
2026-01-30 10:00:10 INFO  WebSocket connected room=ABC123 player=player-1 remote_addr=127.0.0.1:54321
2026-01-30 10:00:15 INFO  Player joined room=ABC123 player_id=p-123 player_name=Alice
```

**Production (JSON format):**
```json
{"time":"2026-01-30T10:00:00Z","level":"INFO","msg":"Server starting","port":"8080"}
{"time":"2026-01-30T10:00:01Z","level":"INFO","msg":"Database connected","pool_size":10}
{"time":"2026-01-30T10:00:05Z","level":"INFO","msg":"HTTP request","method":"POST","path":"/api/rooms","status":201,"duration_ms":45,"request_id":"abc-123","remote_addr":"127.0.0.1:54321"}
{"time":"2026-01-30T10:00:10Z","level":"INFO","msg":"WebSocket connected","room":"ABC123","player":"player-1","remote_addr":"127.0.0.1:54321"}
```

## Rollback Plan

If issues arise:
1. All changes are additive - existing code continues to work
2. Can disable structured logging by removing middleware
3. Can revert to standard `log` package by removing imports
4. Environment variables control all behavior - can disable via config

## Success Criteria

- All HTTP requests logged with timing and status
- All WebSocket connections tracked with room/player context
- All game events (room, player, phase, action) logged
- Logs are structured and searchable in production
- Development logs are human-readable
- Request correlation IDs enable tracing
- Log levels allow filtering noise
- Tests pass without log pollution
- No sensitive data in logs (passwords, tokens)
