# MVP Implementation Plan: Social Deduction Game (Betrayal)

## Summary
This plan addresses all known gaps (per AGENTS.md, MVP-GOALS.md, and code exploration) to enable a playable MVP with room creation/join, real-time gameplay, backend–frontend integration, and robust testing. The approach is prioritized for rapid, incremental implementation and aligns with the architecture and conventions described across project docs.

---

## 1. Backend Implementation Plan
### 1.1. Complete Room, Action, & Game Logic (`room.go`, `errors.go`)
- Implement/stub the following methods in `internal/game/room.go`:
  - `StartGame(code string, hostID string) error` — Locks player list, assigns roles, transitions to NIGHT.
  - `SubmitAction(code, playerID, type, targetID)` — Add action for current phase.
  - `DeleteAction(code, actionID, hostID)` — Remove action by ID (host only).
  - `LeaveRoom(code, playerID)` — Remove a player.
  - Ensure all phase/state validation and error returns follow game rules.
- Extend `errors.go` with additional error types (e.g., `ErrRoomNotFound`, `ErrAlreadyStarted`, `ErrPermissionDenied`, etc.).

### 1.2. Extend Room HTTP Handler (`rooms.go`)
- Add endpoints:
  - `POST /api/rooms/:code/start` (host only)
  - `POST /api/rooms/:code/actions` (player action submission)
  - `DELETE /api/rooms/:code/actions/:actionID` (host, delete queued action)
- Each must validate permissions and state, interact with the room manager/game logic, and broadcast updates via the hub.
- Return standard JSON error structure on failures.

### 1.3. Ensure & Expand Tests (Go)
- Add or update unit & integration tests for new logic and endpoints (see existing `*_test.go` files for patterns).
- Run all backend tests to confirm passing status before any commit.

### 1.4. Document API (Optional, for future work)
- Brief OpenAPI or markdown specification for room/game/action endpoints and payloads.

#### **Key files:**
- `/ai-backend/internal/game/room.go`
- `/ai-backend/internal/game/errors.go`
- `/ai-backend/internal/handlers/rooms.go`

---

## 2. Frontend Implementation Plan
### 2.1. Implement Svelte Stores, API, and WS Client
- Create `src/lib/stores.js`:
  - Export Svelte stores: `player`, `room`, `isHost`, `actions`, `log`.
- Create `src/lib/api.js`:
  - Export HTTP methods: `createRoom`, `joinRoom`, etc., matching backend endpoints.
- Create `src/lib/ws.js`:
  - Manage WebSocket connection, auto-(re)connect, parse messages, and use correct message dispatch/types as per AGENTS.md (player_joined, phase_changed, action_submitted, etc.).
  - Export connect/send/close utilities.

### 2.2. Create In-Game Room Page (`/room/[code]/+page.svelte`)
- UI sections:
  - Player list (state-driven)
  - Host controls (advance phase, delete action)
  - Action queue
  - Event log (updates on WS messages)
  - Error/feedback UI (state-driven)
- Integrate with all stores and WS handlers.
- On-mount: auto-connect WS, cleanup on destroy.

### 2.3. Enhance Landing Page (+page.svelte)
- Replace SvelteKit boilerplate with forms for “Create Room” and “Join Room.”
- Client-side validation on player name/room code inputs.
- Route to `/room/[code]` on success (using returned player/host IDs).

### 2.4. (Optional) UI/UX Polishing
- Integrate Skeleton UI components as time permits.
- Add modals/alerts for error handling and key events.

#### **Key files:**
- `/frontend/src/lib/stores.js`
- `/frontend/src/lib/api.js`
- `/frontend/src/lib/ws.js`
- `/frontend/src/routes/room/[code]/+page.svelte`
- `/frontend/src/routes/+page.svelte`

---

## 3. End-to-End & Testing
- Backend: All tests (`go test ./...`) must remain passing after changes (blocking step before commit).
- Frontend: Basic smoke testing by simulating two players in the browser. Manual steps:
  - Create a room and another browser window joins.
  - Validate actions: players appear, host can advance phase, actions can be queued and deleted, all UI updates in real-time.
- Add basic error state and disconnect/reconnect handling for robustness.

---

## 4. Critical File Paths To Modify or Create
- Backend:  `/ai-backend/internal/game/room.go`, `/ai-backend/internal/game/errors.go`, `/ai-backend/internal/handlers/rooms.go`
- Frontend: `/frontend/src/lib/stores.js`, `/frontend/src/lib/api.js`, `/frontend/src/lib/ws.js`, `/frontend/src/routes/room/[code]/+page.svelte`, `/frontend/src/routes/+page.svelte`

---

## 5. Verification
- **Backend:**
  - `go test ./...` must pass with all major codepaths (rooms, game state, hub, WS) covered.
  - Manual API smoke checks with `curl`/HTTPie or Postman.
- **Frontend:**
  - Open two browser windows, create/join rooms, verify UI sync, phase transitions, and live player updates.
  - Hard-refresh, disconnect, sanity checks for reconnect/intentional failure states.
- **Integration:**
  - At least one successful end-to-end session switching game phases in the UI, visible to multiple clients.

---

**This plan provides a full roadmap for unblocking game MVP with real-time, multi-user play.**

---

After plan approval, I recommend implementing backend missing actions and handler endpoints first (since all tests are in place), followed by frontend stores and room page, then complete wire-up and final smoke testing.